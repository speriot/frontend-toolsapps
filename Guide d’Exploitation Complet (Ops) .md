Parfait StÃ©phane â€” voici **le guide dâ€™exploitation complet (Ops)** pour ton application dÃ©ployÃ©e via Helm sur Kubernetes (k3s, Traefik, certâ€‘manager).  
Câ€™est un vrai **runbook professionnel**, pensÃ© pour Ãªtre utilisÃ© en production, en astreinte, ou quand Â« StÃ©phane du futur Â» doit intervenir rapidement sans tout rÃ©apprendre.

Je lâ€™ai structurÃ© comme un document dâ€™exploitation dâ€™entreprise : clair, opÃ©rationnel, exhaustif.

---

# ğŸ› ï¸ Guide dâ€™Exploitation Complet (Ops)
*Application Node.js dÃ©ployÃ©e via Helm sur Kubernetes (k3s, Traefik, certâ€‘manager)*

---

# ğŸ“¦ 1. Architecture opÃ©rationnelle

## 1.1. Composants
- **k3s** : distribution Kubernetes lÃ©gÃ¨re, monoâ€‘nÅ“ud sur VPS KVM
- **Traefik** : Ingress Controller + reverse proxy
- **certâ€‘manager** : gestion automatique des certificats TLS
- **Helm** : packaging et dÃ©ploiement applicatif
- **Docker** : build et push des images
- **Registry** : GHCR ou Docker Hub
- **Application** : API Node.js exposÃ©e sur port 3000

## 1.2. Flux rÃ©seau
```
Client â†’ DNS â†’ Traefik (80/443) â†’ Service â†’ Pod â†’ Node.js
```

## 1.3. Certificats
- ACME HTTPâ€‘01 via certâ€‘manager
- StockÃ©s en Secret Kubernetes
- Renouvellement automatique

---

# ğŸš€ 2. ProcÃ©dures dâ€™exploitation quotidiennes

## 2.1. VÃ©rifier lâ€™Ã©tat du cluster
```bash
kubectl get nodes
kubectl get pods -A
kubectl get ingress -A
kubectl get certificate -A
```

## 2.2. VÃ©rifier lâ€™Ã©tat de lâ€™application
```bash
kubectl get pods -l app=my-api
kubectl logs deploy/my-api
kubectl rollout status deploy/my-api
```

## 2.3. VÃ©rifier Traefik
```bash
kubectl -n kube-system logs -l app=traefik
kubectl -n kube-system get ingressroute
```

## 2.4. VÃ©rifier certâ€‘manager
```bash
kubectl -n cert-manager logs deploy/cert-manager
kubectl get certificate -A
kubectl get challenge -A
kubectl get order -A
```

---

# ğŸ³ 3. Build & Push Docker (Ops)

## 3.1. Build
```bash
docker build -t ghcr.io/stephane/my-api:1.0.3 .
```

## 3.2. Push
```bash
docker push ghcr.io/stephane/my-api:1.0.3
```

## 3.3. VÃ©rification
```bash
docker pull ghcr.io/stephane/my-api:1.0.3
```

---

# ğŸ›ï¸ 4. DÃ©ploiement Helm (Ops)

## 4.1. Upgrade standard
```bash
helm upgrade my-api ./my-api -f values.yaml
```

## 4.2. VÃ©rifier le dÃ©ploiement
```bash
kubectl rollout status deploy/my-api
kubectl get pods -l app=my-api
```

## 4.3. Voir lâ€™historique
```bash
helm history my-api
```

---

# ğŸ”„ 5. Rollback (Ops)

## 5.1. Identifier la derniÃ¨re version stable
```bash
helm history my-api
```

## 5.2. Rollback
```bash
helm rollback my-api <revision>
```

## 5.3. VÃ©rifier
```bash
kubectl rollout status deploy/my-api
```

---

# ğŸ§¯ 6. DÃ©bogage (Ops)

## 6.1. Pod en CrashLoopBackOff
```bash
kubectl logs deploy/my-api
kubectl describe pod <pod>
```

Causes frÃ©quentes :
- bug applicatif
- variable dâ€™environnement manquante
- port incorrect
- probe mal configurÃ©e

---

## 6.2. ImagePullBackOff
```bash
kubectl describe pod <pod> | grep -i image
```

Causes :
- tag inexistant
- mauvais repository
- pas de pull secret

---

## 6.3. 404 Traefik
VÃ©rifier :
```bash
kubectl get ingress
kubectl get svc my-api -o yaml
kubectl get deploy my-api -o yaml
kubectl -n kube-system logs -l app=traefik
```

Causes :
- mauvais `targetPort`
- mauvais `ingressClassName`
- Pod ne rÃ©pond pas

---

## 6.4. Certificat TLS non gÃ©nÃ©rÃ©
VÃ©rifier :
```bash
kubectl get certificate -A
kubectl describe certificate api-tls
kubectl get challenge -A
kubectl get order -A
kubectl -n cert-manager logs deploy/cert-manager
```

Causes :
- port 80 bloquÃ©
- DNS incorrect
- challenge HTTPâ€‘01 non routÃ©

---

# ğŸ§ª 7. Tests de diagnostic rapides

## 7.1. Tester le Pod directement
```bash
kubectl exec -it deploy/my-api -- wget -qO- http://localhost:3000/health
```

## 7.2. Tester le Service
```bash
kubectl port-forward svc/my-api 8080:80
curl http://localhost:8080/health
```

## 7.3. Tester lâ€™Ingress
```bash
curl -I https://api.mondomaine.fr
```

---

# ğŸ” 8. Gestion des secrets

## 8.1. Voir les secrets
```bash
kubectl get secrets
```

## 8.2. Voir un secret TLS
```bash
kubectl describe secret api-tls
```

## 8.3. RegÃ©nÃ©rer un secret (rare)
```bash
kubectl delete certificate api-tls
```

---

# ğŸ“Š 9. Monitoring & logs

## 9.1. Logs applicatifs
```bash
kubectl logs deploy/my-api -f
```

## 9.2. Logs Traefik
```bash
kubectl -n kube-system logs -l app=traefik -f
```

## 9.3. Logs certâ€‘manager
```bash
kubectl -n cert-manager logs deploy/cert-manager -f
```

---

# ğŸ§¹ 10. Maintenance & nettoyage

## 10.1. Nettoyer les anciennes rÃ©visions Helm
```bash
helm upgrade my-api ./my-api --history-max 5
```

## 10.2. Supprimer les Pods terminÃ©s
```bash
kubectl delete pod --field-selector=status.phase=Succeeded
```

## 10.3. VÃ©rifier lâ€™espace disque
```bash
df -h
docker system df
```

---

# ğŸ§  11. Bonnes pratiques Ops

- Toujours utiliser des tags immuables
- Toujours vÃ©rifier le diff avant upgrade (`helm diff`)
- Toujours tester lâ€™image localement
- Toujours vÃ©rifier lâ€™Ã©tat du cluster avant upgrade
- Toujours documenter chaque changement (pour StÃ©phane du futur)
- Toujours vÃ©rifier les logs aprÃ¨s un dÃ©ploiement
- Toujours garder un rollback prÃªt

---

# ğŸ§­ 12. Workflow Ops complet (rÃ©sumÃ©)

### 1. Build & push Docker
### 2. Modifier `values.yaml`
### 3. `helm upgrade`
### 4. VÃ©rifier rollout
### 5. VÃ©rifier Traefik
### 6. VÃ©rifier certâ€‘manager
### 7. Rollback si nÃ©cessaire
### 8. Documenter

---

